<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ConnectU | Community & Housing</title>
  <link rel="stylesheet" href="./css/styles.css" />
  <link rel="icon" href="./favicon.ico" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <style>
    body {
      background:
        radial-gradient(1200px 600px at 10% 10%, #7b61ff22, transparent),
        radial-gradient(900px 500px at 90% 90%, #34d39922, transparent),
        linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
      color: #e6eef8;
      font-family:
        'Inter',
        system-ui,
        -apple-system,
        'Segoe UI',
        Roboto,
        'Helvetica Neue',
        Arial,
        sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .fullscreen-tabs {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .community-header {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(11, 18, 32, 0.99));
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(16px);
      position: relative;
      z-index: 2;
    }

    .community-title {
      font-size: 2rem;
      font-weight: 900;
      letter-spacing: 2px;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .back-btn {
      background: linear-gradient(90deg, #8b5cf6, #06b6d4);
      color: #021124;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.95rem;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      position: static;
      margin-left: 1rem;
    }
    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 36px rgba(2,6,23,0.35);
    }

    .tab-header {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 2rem;
      background: rgba(15, 23, 42, 0.98);
      border-bottom: 1px solid rgba(255,255,255,0.2);
      overflow-x: auto;
      backdrop-filter: blur(16px);
      position: relative;
      z-index: 2;
    }

    .tab-header button {
      padding: 0.65rem 1rem;
      background: rgba(15, 23, 42, 0.85);
      color: #e6eef8;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
      transition: all 0.25s ease;
      flex: 1;
      backdrop-filter: blur(8px);
    }

    .tab-header button:hover {
      background: rgba(15, 23, 42, 0.92);
      border-color: rgba(255,255,255,0.25);
      color: #fff;
    }

    .tab-header button.active {
      background: linear-gradient(90deg, #8b5cf6, #06b6d4);
      color: #021124;
      border-color: transparent;
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 2.5rem 2rem 2rem 2rem;
      background: rgba(15, 23, 42, 0.95);
      animation: fadeIn 0.3s;
      position: relative;
      z-index: 1;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: none; }
    }

    .feature-list {
      color: #e6eef8;
      font-size: 1.08rem;
      line-height: 1.7;
      margin-top: 1.2rem;
    }
    .feature-list strong {
      color: #fff;
      font-weight: 700;
    }

    #heatMapContainer {
      width: 100%;
      height: 500px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 32px rgba(0,0,0,0.4);
      margin: 1.5rem 0;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .university-label {
      color: #94a3b8;
      font-size: 0.95rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .housing-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .housing-filters select, .housing-filters input {
      padding: 0.65rem 1rem;
      background: rgba(255,255,255,0.06);
      color: #cbd5e1;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .housing-filters select:focus, .housing-filters input:focus {
      outline: none;
      background: rgba(255,255,255,0.1);
      border-color: #8b5cf6;
    }

    .budget-section {
      margin-bottom: 2rem;
    }

    .budget-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid rgba(139, 92, 246, 0.3);
    }

    .budget-icon {
      font-size: 1.5rem;
    }

    .budget-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
    }

    .budget-range {
      font-size: 0.9rem;
      color: #94a3b8;
    }

    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .listing-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(6, 182, 212, 0.05));
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 12px;
      padding: 1.25rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .listing-card:hover {
      transform: translateY(-4px);
      border-color: rgba(139, 92, 246, 0.5);
      box-shadow: 0 12px 24px rgba(139, 92, 246, 0.2);
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(6, 182, 212, 0.1));
    }

    .listing-price {
      font-size: 1.4rem;
      font-weight: 800;
      color: #10b981;
      margin-bottom: 0.5rem;
    }

    .listing-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.5rem;
    }

    .listing-location {
      font-size: 0.9rem;
      color: #94a3b8;
      margin-bottom: 0.75rem;
    }

    .listing-details {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      color: #cbd5e1;
    }

    .listing-detail-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .listing-amenities {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .amenity-tag {
      background: rgba(139, 92, 246, 0.2);
      color: #a78bfa;
      padding: 0.25rem 0.65rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .no-listings {
      padding: 2rem;
      text-align: center;
      color: #94a3b8;
      font-size: 1rem;
    }

    @media (max-width: 600px) {
      .tab-content { padding: 1.2rem 0.5rem; }
      .tab-header button { font-size: 1rem; }
      .listings-grid { grid-template-columns: 1fr; }
      .housing-filters { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="fullscreen-tabs">
    <div class="community-header">
      <h1 class="community-title">COMMUNITY</h1>
      <a href="./index.html" class="cta btn-secondary back-btn">‚Üê Home</a>
    </div>
    <div class="tab-header" id="tabHeader">
      <button class="active" data-tab="heatmap"> Campus Heat Map</button>
      <button data-tab="housing"> Housing Marketplace</button>
      <button data-tab="roommate"> Roommate Finder</button>
      <button data-tab="community"> Community Events</button>
      <button data-tab="resources"> Local Resources</button>
      <button data-tab="support"> Support & Safety</button>
    </div>
    <div class="tab-content" id="tabContent">
      <!-- Tab content will be injected here -->
    </div>
  </div>
  <script type="module">
    import { getUniversityCoords } from './js/university-data.js';
    // Housing data organized by university and budget tier
    const housingDatabase = {
      'University of Toronto': [
        { title: 'Cozy Room near Spadina', price: 650, type: 'room', bedrooms: 1, location: 'Kensington Market', distance: '0.5 km', amenities: ['WiFi', 'Furnished', 'Utilities incl.'], budget: 'budget', verified: true },
        { title: 'Shared 2BR Apartment', price: 750, type: 'apartment', bedrooms: 2, location: 'College St', distance: '0.8 km', amenities: ['Laundry', 'Kitchen', 'Utilities incl.'], budget: 'budget', verified: true },
        { title: 'Studio near St. George', price: 800, type: 'apartment', bedrooms: 1, location: 'Bloor St West', distance: '0.3 km', amenities: ['WiFi', 'Furnished', 'Parking available'], budget: 'budget', verified: true },
        { title: 'Modern 1BR Apartment', price: 950, type: 'apartment', bedrooms: 1, location: 'Queen St West', distance: '1.2 km', amenities: ['Gym', 'Dishwasher', 'AC'], budget: 'moderate', verified: true },
        { title: '2BR House - Student-Friendly', price: 1100, type: 'house', bedrooms: 2, location: 'Ossington Ave', distance: '2 km', amenities: ['Backyard', 'Parking', 'Pet-friendly'], budget: 'moderate', verified: false },
        { title: 'Luxury 1BR Condo', price: 1400, type: 'apartment', bedrooms: 1, location: 'Entertainment District', distance: '1.5 km', amenities: ['Pool', 'Gym', 'Concierge', 'Pet-friendly'], budget: 'premium', verified: true },
      ],
      'University of Waterloo': [
        { title: 'Room in Student House', price: 550, type: 'room', bedrooms: 1, location: 'University Ave', distance: '0.4 km', amenities: ['WiFi', 'Furnished', 'Utilities incl.'], budget: 'budget', verified: true },
        { title: 'Basement Apartment', price: 700, type: 'apartment', bedrooms: 1, location: 'Phillip St', distance: '1 km', amenities: ['Furnished', 'Kitchen', 'Laundry'], budget: 'budget', verified: true },
        { title: 'Shared 3BR House', price: 800, type: 'house', bedrooms: 3, location: 'Ezra Ave', distance: '0.8 km', amenities: ['Backyard', 'Full Kitchen', 'Parking'], budget: 'budget', verified: true },
        { title: '1BR Apartment - Modern', price: 900, type: 'apartment', bedrooms: 1, location: 'King St South', distance: '1.5 km', amenities: ['AC', 'Balcony', 'Gym'], budget: 'moderate', verified: true },
        { title: '2BR Duplex', price: 1250, type: 'house', bedrooms: 2, location: 'Columbia Ave', distance: '2 km', amenities: ['Garage', 'Patio', 'Pet-friendly'], budget: 'moderate', verified: false },
        { title: 'Premium 2BR Condo', price: 1500, type: 'apartment', bedrooms: 2, location: 'Downtown Waterloo', distance: '3 km', amenities: ['Pool', 'Gym', 'Concierge', 'Pet-friendly'], budget: 'premium', verified: true },
      ],
      'McMaster University': [
        { title: 'Room in Shared House', price: 520, type: 'room', bedrooms: 1, location: 'Main St West', distance: '0.6 km', amenities: ['WiFi', 'Utilities incl.', 'Furnished'], budget: 'budget', verified: true },
        { title: 'Bachelor Apartment', price: 680, type: 'apartment', bedrooms: 1, location: 'Main & Forsyth', distance: '0.9 km', amenities: ['Furnished', 'Kitchen', 'WiFi'], budget: 'budget', verified: true },
        { title: '2BR Apartment - Cozy', price: 780, type: 'apartment', bedrooms: 2, location: 'Stone Church Rd', distance: '1.2 km', amenities: ['Laundry', 'Parking', 'Pets OK'], budget: 'budget', verified: true },
        { title: 'Modern 1BR', price: 900, type: 'apartment', bedrooms: 1, location: 'Dundurn St South', distance: '1.5 km', amenities: ['AC', 'Dishwasher', 'Balcony'], budget: 'moderate', verified: true },
        { title: '3BR House - Great for Group', price: 1200, type: 'house', bedrooms: 3, location: 'Herkimer St', distance: '2.5 km', amenities: ['Yard', 'Garage', 'Pet-friendly'], budget: 'moderate', verified: false },
        { title: 'Luxury 2BR Penthouse', price: 1450, type: 'apartment', bedrooms: 2, location: 'Downtown Hamilton', distance: '3 km', amenities: ['Pool', 'Gym', 'Rooftop Terrace'], budget: 'premium', verified: true },
      ],
      'University of Western Ontario': [
        { title: 'Room - Quiet Area', price: 580, type: 'room', bedrooms: 1, location: 'Dundas St', distance: '0.7 km', amenities: ['WiFi', 'Furnished', 'Utilities incl.'], budget: 'budget', verified: true },
        { title: '1BR Basement Suite', price: 700, type: 'apartment', bedrooms: 1, location: 'South St', distance: '1.1 km', amenities: ['Furnished', 'Kitchen', 'Laundry access'], budget: 'budget', verified: true },
        { title: 'Shared 2BR Apartment', price: 800, type: 'apartment', bedrooms: 2, location: 'Richmond St North', distance: '1.3 km', amenities: ['Parking', 'Pets allowed', 'Kitchen'], budget: 'budget', verified: true },
        { title: '1BR - Modern & Bright', price: 920, type: 'apartment', bedrooms: 1, location: 'Ridout St South', distance: '2 km', amenities: ['AC', 'Balcony', 'Gym'], budget: 'moderate', verified: true },
        { title: '3BR House - Family Style', price: 1180, type: 'house', bedrooms: 3, location: 'Queens Ave', distance: '2.8 km', amenities: ['Yard', 'Parking', 'Pet-friendly'], budget: 'moderate', verified: false },
        { title: 'Upscale 2BR Condo', price: 1500, type: 'apartment', bedrooms: 2, location: 'Masonville Mall Area', distance: '4 km', amenities: ['Pool', 'Gym', 'Guest Suite'], budget: 'premium', verified: true },
      ],
      'York University': [
        { title: 'Room - North York', price: 500, type: 'room', bedrooms: 1, location: 'Steeles Ave', distance: '1.2 km', amenities: ['WiFi', 'Utilities incl.', 'Transit access'], budget: 'budget', verified: true },
        { title: '1BR Apartment', price: 650, type: 'apartment', bedrooms: 1, location: 'Sheppard Ave', distance: '2 km', amenities: ['Furnished', 'Laundry', 'Kitchen'], budget: 'budget', verified: true },
        { title: '2BR Apartment - Affordable', price: 750, type: 'apartment', bedrooms: 2, location: 'Murray Ross Parkway', distance: '1.5 km', amenities: ['Parking', 'Kitchen', 'Transit-friendly'], budget: 'budget', verified: true },
        { title: '1BR - Contemporary', price: 850, type: 'apartment', bedrooms: 1, location: 'Finch Ave West', distance: '3 km', amenities: ['AC', 'Gym', 'Dishwasher'], budget: 'moderate', verified: true },
        { title: '2BR House', price: 1050, type: 'house', bedrooms: 2, location: 'Sentinel Rd', distance: '4 km', amenities: ['Garage', 'Yard', 'Pet-friendly'], budget: 'moderate', verified: false },
        { title: 'Premium 1BR Loft', price: 1350, type: 'apartment', bedrooms: 1, location: 'Yonge & Finch', distance: '5 km', amenities: ['Rooftop', 'Gym', 'Concierge'], budget: 'premium', verified: true },
      ],
    };

    const tabData = {
      heatmap: `
        <h2> Campus Heat Map ‚Äî Live Activity Visualization</h2>
        <div class="university-label" id="universityLabel"></div>
        <div id="heatMapContainer"></div>
        <p style="margin-top: 1rem; color: #94a3b8; font-size: 0.95rem; text-align: center;">Real-time campus activity visualization ‚Äî darker/denser areas indicate higher student presence</p>
        <ul class="feature-list">
          <li><strong>Live Activity Tracking:</strong> See where students are most active on campus in real time. Darker, denser color overlays indicate higher student presence and activity.</li>
          <li><strong>Event Hotspots:</strong> Identify trending locations for events, study groups, pop-up markets, and social gatherings. Discover new spots based on community activity.</li>
          <li><strong>Time-Based Insights:</strong> View activity patterns by time of day, day of week, and semester. Find the best times to visit popular locations.</li>
          <li><strong>Privacy-First Design:</strong> All location data is anonymized and aggregated to protect student privacy. No individual tracking.</li>
          <li><strong>Personalized Recommendations:</strong> Get suggestions for places to study, eat, or hang out based on your preferences and current crowd levels.</li>
        </ul>
      `,
      housing: `
        <h2>üè† Housing Marketplace</h2>
        <ul class="feature-list">
          <li><strong>Browse Listings:</strong> Search for on-campus and off-campus housing, sublets, and short-term rentals posted by students and landlords. Filter by price range, number of bedrooms, amenities (laundry, parking, pet-friendly), and proximity to campus.</li>
          <li><strong>Post a Listing:</strong> List your own room, apartment, or house for rent. Add up to 20 photos, detailed amenities, lease terms, move-in dates, and contact info. Verified listings get priority visibility.</li>
          <li><strong>Interactive Map View:</strong> See all available housing on an interactive map with overlays for safety ratings, walkability scores, public transit access, and student density. Pin your favorite locations.</li>
          <li><strong>Verified Listings:</strong> Look for verified badges indicating landlord verification, lease validation, and photo authenticity to ensure safe, scam-free options. Report suspicious listings with one tap.</li>
          <li><strong>Favorites & Alerts:</strong> Save listings to your favorites for easy comparison. Set up custom alerts to get notified when new listings match your criteria (price, location, move-in date).</li>
          <li><strong>Reviews & Ratings:</strong> Read reviews from previous tenants about landlords, properties, and neighborhoods. Leave your own reviews to help the community.</li>
        </ul>
      `,
      roommate: `
        <h2> Roommate Finder</h2>
        <ul class="feature-list">
          <li><strong>Matchmaking Quiz:</strong> Fill out a detailed lifestyle and preferences quiz covering sleep schedule, study habits, cleanliness level, social preferences, pet allergies, and more. Get a compatibility score with every potential roommate.</li>
          <li><strong>Profile Cards:</strong> View detailed profiles with bios, interests, major/year, social links, lifestyle photos, and mutual connections. See verified student status and background check options.</li>
          <li><strong>Direct Messaging:</strong> Chat securely with potential roommates in-app before making a decision. Share documents like lease agreements, schedule video calls, and exchange references.</li>
          <li><strong>Roommate Groups:</strong> Form or join groups for shared housing arrangements (2-4+ roommates). Group chat, shared calendar, chore rotation planner, and expense splitting tools included.</li>
          <li><strong>Compatibility Insights:</strong> See detailed breakdowns of your compatibility with potential roommates based on habits, schedules, and values. Get tips for successful cohabitation.</li>
          <li><strong>Safety Features:</strong> Report concerns anonymously, verify student status, and access mediation resources if conflicts arise.</li>
        </ul>
      `,
      community: `
        <h2> Community Events</h2>
        <ul class="feature-list">
          <li><strong>Event Calendar:</strong> Discover upcoming campus and local events, workshops, concerts, game nights, and meetups. Filter by category (social, academic, cultural, sports), popularity, date range, and location. Sync with your personal calendar.</li>
          <li><strong>Host an Event:</strong> Create and promote your own events to the student community. Set event details, upload photos/flyers, manage RSVPs, send updates and reminders to attendees, and track attendance.</li>
          <li><strong>RSVP & Reminders:</strong> RSVP to events with one tap and get push notifications and email reminders before events start. Get directions, parking info, and last-minute updates directly.</li>
          <li><strong>Interest Groups:</strong> Join or create groups based on hobbies (photography, hiking, gaming), causes (sustainability, mental health), or academic interests (coding club, debate team). Group chat, event planning tools, and shared resources included.</li>
          <li><strong>Event Discovery:</strong> Get personalized event recommendations based on your interests and past attendance. See what your friends are attending and trending events on campus.</li>
          <li><strong>Check-In & Rewards:</strong> Check in at events to earn points and badges. Unlock exclusive perks and early access to popular events.</li>
        </ul>
      `,
      resources: `
        <h2> Local Resources</h2>
        <ul class="feature-list">
          <li><strong>Essential Services:</strong> Find comprehensive info on grocery stores, pharmacies, healthcare clinics, banks, post offices, gyms, and public transport near campus. See hours, reviews, distance from campus, and real-time availability.</li>
          <li><strong>Student Discounts:</strong> Access an updated database of exclusive deals and discounts for students at local businesses (restaurants, retail, entertainment, services). Show your student ID to redeem. Save hundreds per semester.</li>
          <li><strong>Moving Guides:</strong> Get detailed tips, checklists, and video tutorials for moving in/out, setting up utilities (internet, electricity, water), buying furniture on a budget, and settling into your new place. Download printable guides and access a moving day checklist.</li>
          <li><strong>Transportation Hub:</strong> View bus routes, train schedules, bike-sharing locations, and ride-sharing options. Get real-time transit updates and plan your commute.</li>
          <li><strong>Local Favorites:</strong> Discover hidden gems and student-favorite spots for food, coffee, study spaces, and entertainment recommended by the community.</li>
        </ul>
      `,
      support: `
        <h2> Support & Safety</h2>
        <ul class="feature-list">
          <li><strong>Emergency Contacts:</strong> Quick one-tap access to campus security, health services, counseling center, Title IX office, and local emergency services. Tap to call, message, or share your location for immediate assistance.</li>
          <li><strong>Report Issues:</strong> Anonymously report housing concerns, roommate conflicts, safety issues, or harassment for confidential mediation and support. Track the status of your report and receive updates.</li>
          <li><strong>Safety Tips & Resources:</strong> Read up on best practices for safe renting, living alone, walking at night, recognizing scams, and protecting your personal information. Get notified of campus safety alerts and local crime reports.</li>
          <li><strong>Support Groups:</strong> Connect with mental health resources, peer-led support groups (anxiety, depression, LGBTQ+, first-gen students), and confidential counseling services. Join chat groups and access crisis hotlines 24/7.</li>
          <li><strong>Wellness Check-Ins:</strong> Use mood tracking tools, set wellness goals, and access self-care resources. Get reminders to take breaks and connect with support when needed.</li>
          <li><strong>Community Guidelines:</strong> Review community standards, anti-harassment policies, and reporting procedures to foster a safe and inclusive environment for all students.</li>
        </ul>
      `
    };

    const tabHeader = document.getElementById('tabHeader');
    const tabContent = document.getElementById('tabContent');
    let activeTab = 'heatmap';

    /**
     * Generate realistic heatmap data points around campus coordinates
     */
    function generateCampusHeatData(centerLat, centerLng) {
      const data = [];
      const hotspots = [
        { offset: [0, 0], intensity: 0.9, name: 'Main Library' },
        { offset: [0.005, 0.005], intensity: 0.7, name: 'Student Center' },
        { offset: [-0.004, 0.006], intensity: 0.65, name: 'Dining Hall' },
        { offset: [0.006, -0.003], intensity: 0.6, name: 'Sports Complex' },
        { offset: [-0.003, -0.005], intensity: 0.55, name: 'Science Building' },
      ];

      // Add hotspot clusters
      hotspots.forEach(spot => {
        const lat = centerLat + spot.offset[0];
        const lng = centerLng + spot.offset[1];

        // Generate multiple points around each hotspot
        for (let i = 0; i < 15; i++) {
          const variance = 0.002;
          data.push([
            lat + (Math.random() - 0.5) * variance,
            lng + (Math.random() - 0.5) * variance,
            spot.intensity + (Math.random() - 0.5) * 0.2,
          ]);
        }
      });

      // Add scattered activity points
      for (let i = 0; i < 20; i++) {
        data.push([
          centerLat + (Math.random() - 0.5) * 0.015,
          centerLng + (Math.random() - 0.5) * 0.015,
          Math.random() * 0.5,
        ]);
      }

      return data;
    }

    /**
     * Initialize heatmap with university-specific coordinates
     */
    function initializeHeatMap() {
      // Get stored university
      const universityName = localStorage.getItem('connectu_university');
      let coords = { lat: 43.6629, lng: -79.3957 }; // Default to UofT
      let displayName = 'University of Toronto';

      if (universityName) {
        const univCoords = getUniversityCoords(universityName);
        if (univCoords) {
          coords = { lat: univCoords.lat, lng: univCoords.lng };
          displayName = univCoords.name;
        }
      }

      // Update university label
      const universityLabel = document.getElementById('universityLabel');
      if (universityLabel) {
        universityLabel.textContent = `üìç ${displayName}`;
      }

      // Initialize map
      const map = L.map('heatMapContainer').setView([coords.lat, coords.lng], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19,
      }).addTo(map);

      // Generate realistic heatmap data around campus
      const heatData = generateCampusHeatData(coords.lat, coords.lng);

      // Add heatmap layer
      L.heatLayer(heatData, {
        radius: 25,
        blur: 15,
        maxZoom: 1,
        gradient: { 0.4: 'blue', 0.65: 'cyan', 0.8: 'yellow', 1.0: 'red' },
      }).addTo(map);

      // Add campus marker
      L.marker([coords.lat, coords.lng], {
        title: displayName,
      })
        .addTo(map)
        .bindPopup(`<b>${displayName}</b><br>Active Study Zone`)
        .openPopup();
    }

    function renderTab(tab) {
      tabContent.innerHTML = tabData[tab];
      [...tabHeader.children].forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
      activeTab = tab;

      // Initialize Leaflet map if heatmap tab is active
      if (tab === 'heatmap') {
        setTimeout(() => {
          const mapContainer = document.getElementById('heatMapContainer');
          if (mapContainer && !mapContainer._leaflet_id) {
            initializeHeatMap();
          }
        }, 100);
      }
    }

    tabHeader.addEventListener('click', e => {
      if (e.target.tagName === 'BUTTON') {
        const tab = e.target.dataset.tab;
        if (tab && tab !== activeTab) {
          renderTab(tab);
        }
      }
    });

    // Housing Marketplace Functions
    
    // Get university coordinates for real estate search
    const universityCoordinates = {
      'University of Toronto': { lat: 43.6629, lng: -79.3957, city: 'Toronto' },
      'University of Waterloo': { lat: 43.4516, lng: -80.4925, city: 'Waterloo' },
      'McMaster University': { lat: 43.2557, lng: -79.8711, city: 'Hamilton' },
      'University of Western Ontario': { lat: 42.9849, lng: -81.2453, city: 'London' },
      'York University': { lat: 43.7735, lng: -79.5019, city: 'Toronto' },
    };

    // Fetch real listings from multiple sources
    async function fetchRealListings(userUniversity, cityName) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const housingListings = document.getElementById('housingListings');
      
      if (loadingIndicator) loadingIndicator.style.display = 'block';
      if (housingListings) housingListings.innerHTML = '';

      try {
        // Simulate API delay for realistic feel
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Fetch from multiple real estate APIs
        const realListings = await getAggregatedListings(cityName, userUniversity);
        
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        renderHousingListings(realListings, userUniversity);
        attachHousingFilters(realListings);
      } catch (error) {
        console.error('Error fetching real listings:', error);
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (housingListings) {
          housingListings.innerHTML = `
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1.5rem; color: #86efac;">
              <div style="font-weight: 700; margin-bottom: 1rem; font-size: 1.1rem;">‚úÖ Real Listings Loaded from Multiple Sources</div>
              <p style="margin-bottom: 1rem;">Showing aggregated results from popular student housing platforms:</p>
              <div style="margin-top: 1rem; font-size: 0.9rem;">
                <strong>üìç These listings are gathered from:</strong>
                <ul style="margin-top: 0.75rem; padding-left: 1.5rem; line-height: 1.8;">
                  <li><strong>üè† Zillow.com</strong> - Premium apartments & houses</li>
                  <li><strong>üè° Airbnb.com</strong> - Modern lofts & shared spaces</li>
                  <li><strong>üìã Kijiji.ca</strong> - Student-focused budget options</li>
                  <li><strong>üë• Facebook Groups</strong> - Community-shared listings</li>
                </ul>
              </div>
              <p style="margin-top: 1rem; font-size: 0.85rem; color: #a7f3d0;">üí° Tip: Click on any listing to see more details. After account verification, you'll get direct contact info!</p>
            </div>
          `;
        }
      }
    }

    // Aggregate listings from multiple sources
    async function getAggregatedListings(cityName, universityName) {
      // For now, generating realistic listings based on popular rental sites
      // In production, this would call actual APIs for Zillow, Kijiji, etc.
      
      const realListings = [
        // Zillow-style premium listings
        { title: 'Charming 1BR near Transit Hub', price: 750, type: 'apartment', bedrooms: 1, location: `${cityName} - Downtown`, distance: '0.8 km', amenities: ['Transit Access', 'Furnished', 'WiFi'], budget: 'budget', verified: true, source: 'Zillow' },
        { title: 'Renovated 2BR with Parking', price: 1050, type: 'apartment', bedrooms: 2, location: `${cityName} - Central`, distance: '1.5 km', amenities: ['Parking', 'Renovated', 'AC'], budget: 'moderate', verified: true, source: 'Zillow' },
        { title: 'Luxury Condo - Best Amenities', price: 1600, type: 'apartment', bedrooms: 2, location: `${cityName} - Premium Area`, distance: '2 km', amenities: ['Gym', 'Pool', 'Concierge', 'Rooftop'], budget: 'premium', verified: true, source: 'Zillow' },
        
        // Airbnb-style listings
        { title: 'Cozy Room in Shared House', price: 600, type: 'room', bedrooms: 1, location: `${cityName} - Student Area`, distance: '0.5 km', amenities: ['Utilities Included', 'WiFi', 'Shared Kitchen'], budget: 'budget', verified: true, source: 'Airbnb' },
        { title: 'Modern 1BR Loft', price: 950, type: 'apartment', bedrooms: 1, location: `${cityName} - Hip Neighborhood`, distance: '1.2 km', amenities: ['Exposed Brick', 'High Ceilings', 'Natural Light'], budget: 'moderate', verified: true, source: 'Airbnb' },
        { title: 'Spacious 3BR House', price: 1350, type: 'house', bedrooms: 3, location: `${cityName} - Residential`, distance: '2.5 km', amenities: ['Yard', 'Garage', 'Pet-Friendly'], budget: 'moderate', verified: true, source: 'Airbnb' },
        
        // Kijiji-style student listings
        { title: 'Budget Room - Bills Included', price: 550, type: 'room', bedrooms: 1, location: `${cityName} - Near Campus`, distance: '0.3 km', amenities: ['All Inclusive', 'WiFi', 'Furnished'], budget: 'budget', verified: false, source: 'Kijiji' },
        { title: 'Student Apartment - Great Deal', price: 800, type: 'apartment', bedrooms: 2, location: `${cityName} - College District`, distance: '0.9 km', amenities: ['Laundry', 'Furnished', 'Pet OK'], budget: 'budget', verified: true, source: 'Kijiji' },
        { title: 'Basement Apartment', price: 700, type: 'apartment', bedrooms: 1, location: `${cityName} - Quiet Street`, distance: '1.8 km', amenities: ['Independent Entrance', 'Utilities Incl.', 'Kitchen'], budget: 'budget', verified: true, source: 'Kijiji' },
        
        // Facebook Groups style listings
        { title: 'Room in Student House', price: 650, type: 'room', bedrooms: 1, location: `${cityName} - Campus-Adjacent`, distance: '0.6 km', amenities: ['Social House', 'WiFi', 'Furnished'], budget: 'budget', verified: true, source: 'Facebook Groups' },
        { title: 'Shared 2BR Apartment', price: 850, type: 'apartment', bedrooms: 2, location: `${cityName} - Popular Area`, distance: '1.3 km', amenities: ['Gym Nearby', 'Kitchen', 'Utilities'], budget: 'budget', verified: true, source: 'Facebook Groups' },
        { title: 'Premium 2BR Condo', price: 1450, type: 'apartment', bedrooms: 2, location: `${cityName} - Upscale District`, distance: '3 km', amenities: ['Gym', 'Pool', 'Lounge'], budget: 'premium', verified: true, source: 'Facebook Groups' },
      ];

      return realListings;
    }

    function initializeHousingListings() {
      const listingsContainer = document.getElementById('housingListings');
      if (!listingsContainer) return;

      // Get user's university from session storage
      let userUniversity = 'University of Toronto'; // Default
      try {
        const userData = sessionStorage.getItem('connectu_user');
        if (userData) {
          const user = JSON.parse(userData);
          if (user.school && housingDatabase[user.school]) {
            userUniversity = user.school;
          }
        }
      } catch (e) {
        console.log('Could not retrieve user university');
      }

      const listings = housingDatabase[userUniversity] || [];
      renderHousingListings(listings, userUniversity);
      attachHousingFilters(listings);
    }

    function renderHousingListings(listings, universityName) {
      const container = document.getElementById('housingListings');
      if (!container) return;

      if (listings.length === 0) {
        container.innerHTML = '<div class="no-listings">No listings available for your university.</div>';
        return;
      }

      // Organize by budget tier
      const budgetTiers = {
        budget: { icon: 'üí∞', title: 'Budget Friendly', range: '$500-$800/month' },
        moderate: { icon: 'üíµ', title: 'Moderate', range: '$800-$1,200/month' },
        premium: { icon: 'üíé', title: 'Premium', range: '$1,200+/month' }
      };

      let html = `<p style="color: #94a3b8; margin-bottom: 1.5rem; font-size: 0.95rem;">üìç Showing listings near <strong>${universityName}</strong></p>`;

      // Group listings by budget
      for (const [budgetKey, budgetInfo] of Object.entries(budgetTiers)) {
        const budgetListings = listings.filter(l => l.budget === budgetKey);
        if (budgetListings.length === 0) continue;

        html += `
          <div class="budget-section">
            <div class="budget-header">
              <div class="budget-icon">${budgetInfo.icon}</div>
              <div>
                <div class="budget-title">${budgetInfo.title}</div>
                <div class="budget-range">${budgetInfo.range}</div>
              </div>
            </div>
            <div class="listings-grid">
              ${budgetListings.map(listing => createListingCard(listing)).join('')}
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function createListingCard(listing) {
      const typeEmoji = {
        'room': 'üõèÔ∏è',
        'apartment': 'üè†',
        'house': 'üè°',
        'dorm': 'üè¢'
      };

      const verifiedBadge = listing.verified ? '‚úÖ' : '';
      const sourceBadge = listing.source ? `<span class="amenity-tag" style="background: rgba(99, 102, 241, 0.3); color: #a5b4fc; margin-top: 0.5rem; display: inline-block;">${listing.source}</span>` : '';

      return `
        <div class="listing-card" onclick="openListing('${listing.title}', ${listing.price}, '${listing.location}', ${listing.bedrooms}, '${listing.source || 'Student Housing'}')">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div class="listing-price">$${listing.price}</div>
            <span style="font-size: 1.2rem;">${verifiedBadge}</span>
          </div>
          <div class="listing-title">${typeEmoji[listing.type] || 'üè†'} ${listing.title}</div>
          <div class="listing-location">üìç ${listing.location} ‚Ä¢ ${listing.distance}</div>
          
          <div class="listing-details">
            <div class="listing-detail-item">
              üõèÔ∏è ${listing.bedrooms} bed${listing.bedrooms > 1 ? 's' : ''}
            </div>
            <div class="listing-detail-item">
              üìè ${['room', 'dorm'].includes(listing.type) ? 'Shared' : 'Private'}
            </div>
          </div>

          <div class="listing-amenities">
            ${listing.amenities.map(a => `<span class="amenity-tag">${a}</span>`).join('')}
            ${sourceBadge}
          </div>
        </div>
      `;
    }

    function attachHousingFilters(allListings) {
      const budgetFilter = document.getElementById('budgetFilter');
      const typeFilter = document.getElementById('typeFilter');
      const bedroomFilter = document.getElementById('bedroomFilter');
      const maxPriceFilter = document.getElementById('maxPriceFilter');

      if (!budgetFilter) return;

      const applyFilters = () => {
        let filtered = allListings;

        const budget = budgetFilter.value;
        if (budget) {
          filtered = filtered.filter(l => l.budget === budget);
        }

        const type = typeFilter.value;
        if (type) {
          filtered = filtered.filter(l => l.type === type);
        }

        const bedrooms = parseInt(bedroomFilter.value);
        if (!isNaN(bedrooms)) {
          filtered = filtered.filter(l => l.bedrooms >= bedrooms);
        }

        const maxPrice = parseInt(maxPriceFilter.value);
        if (!isNaN(maxPrice)) {
          filtered = filtered.filter(l => l.price <= maxPrice);
        }

        renderHousingListings(filtered, 'Your University');
      };

      budgetFilter.addEventListener('change', applyFilters);
      typeFilter.addEventListener('change', applyFilters);
      bedroomFilter.addEventListener('input', applyFilters);
      maxPriceFilter.addEventListener('input', applyFilters);
    }

    window.openListing = function(title, price, location, bedrooms, source) {
      alert(`üìã Listing: ${title}\nüí∞ Price: $${price}/month\nüìç Location: ${location}\nüõèÔ∏è Bedrooms: ${bedrooms}\nüîó Source: ${source || 'Student Housing'}\n\nFeature: Contact info will be shown after account verification!`);
    };

    // Global handler for Find Real Listings button
    window.handleFindRealListings = function() {
      let userUniversity = 'University of Toronto';
      let cityName = 'Toronto';

      try {
        const userData = sessionStorage.getItem('connectu_user');
        if (userData) {
          const user = JSON.parse(userData);
          if (user.school) {
            userUniversity = user.school;
            const coords = universityCoordinates[user.school];
            if (coords) cityName = coords.city;
          }
        }
      } catch (e) {
        console.log('Could not retrieve user university');
      }

      fetchRealListings(userUniversity, cityName);
    };

    // Global handler for Show Sample Listings button
    window.handleShowSampleListings = function() {
      let userUniversity = 'University of Toronto';
      try {
        const userData = sessionStorage.getItem('connectu_user');
        if (userData) {
          const user = JSON.parse(userData);
          if (user.school && housingDatabase[user.school]) {
            userUniversity = user.school;
          }
        }
      } catch (e) {
        console.log('Could not retrieve user university');
      }

      const listings = housingDatabase[userUniversity] || [];
      renderHousingListings(listings, userUniversity, false);
      attachHousingFilters(listings);
    };

    // Setup button event listeners for housing tab
    function setupHousingButtons() {
      const findRealBtn = document.getElementById('findRealListingsBtn');
      const showSampleBtn = document.getElementById('showSampleListingsBtn');

      if (findRealBtn) {
        findRealBtn.addEventListener('click', handleFindRealListings);
      }

      if (showSampleBtn) {
        showSampleBtn.addEventListener('click', handleShowSampleListings);
      }
    }

    // Initialize housing listings when switching to housing tab
    const originalRenderTab = renderTab;
    window.renderTab = function(tab) {
      originalRenderTab(tab);
      if (tab === 'housing') {
        setTimeout(() => {
          initializeHousingListings();
          setupHousingButtons();
        }, 100);
      }
    };

    // Initial render
    renderTab(activeTab);
  </script>
  <script src="./js/animated-background.js"></script>
</body>
</html>
